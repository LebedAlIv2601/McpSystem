# Руководство по использованию модуля аналитики

## Обзор

Модуль аналитики добавляет в Telegram-бот возможность анализа поведения пользователей интернет-магазина с использованием локального MCP сервера и модели Ollama.

## Архитектура

```
┌─────────────────┐
│ Telegram User   │
└────────┬────────┘
         │
         ↓
┌─────────────────────────────────────┐
│      Telegram Bot (bot.py)          │
│  - Определяет тип запроса            │
│  - Аналитика или общий вопрос        │
└────────┬────────────────────────────┘
         │
         ├───────────────┐
         │               │
         ↓               ↓
┌──────────────┐  ┌──────────────────┐
│ Ollama       │  │ Analytics Manager│
│ (общие       │  │ + MCP Server     │
│  вопросы)    │  │ (аналитика)      │
└──────────────┘  └────────┬─────────┘
                           │
                           ↓
                  ┌─────────────────┐
                  │ events.json     │
                  │ (100 событий)   │
                  └─────────────────┘
```

## Установка и запуск

### 1. Установите зависимости

```bash
cd client
pip install -r requirements.txt
```

### 2. Убедитесь, что Ollama установлена

```bash
ollama pull llama3.1:8b
```

### 3. Запустите бота

```bash
python main.py
```

При запуске автоматически:
- Запустится Ollama (если не запущена)
- Запустится Analytics MCP сервер
- Подключится Telegram бот

## Использование в Telegram

### Аналитические вопросы

Бот автоматически определяет аналитические запросы по ключевым словам:

#### 1. Анализ ошибок
**Ключевые слова:** `ошибк`, `error`

**Примеры:**
- "Какие ошибки чаще всего получают пользователи?"
- "Покажи статистику по ошибкам"
- "Какие проблемы испытывают пользователи?"

**Что показывает:**
- Топ ошибок по частоте
- Количество затронутых пользователей
- Экраны, где произошли ошибки
- Примеры сообщений об ошибках

#### 2. Анализ воронки конверсии
**Ключевые слова:** `воронк`, `funnel`, `конверс`, `conversion`

**Примеры:**
- "Какая конверсия в покупку?"
- "Покажи воронку продаж"
- "Сколько пользователей доходит до оплаты?"

**Что показывает:**
- Количество пользователей на каждом этапе
- Процент конверсии от начала
- Процент оттока между этапами

#### 3. Анализ оттока
**Ключевые слова:** `теряю`, `dropoff`, `отток`, `abandon`

**Примеры:**
- "Где больше всего пользователей теряется?"
- "На каком экране происходит максимальный отток?"
- "Где пользователи бросают покупки?"

**Что показывает:**
- Экраны с максимальным оттоком
- Процент оттока на каждом экране

#### 4. Общая статистика
**Ключевые слова:** `статистик`, `statistic`, `общ`

**Примеры:**
- "Покажи общую статистику"
- "Какие основные метрики приложения?"
- "Дай общий обзор данных"

**Что показывает:**
- Всего пользователей, сессий, событий
- Завершенные покупки
- Процент конверсии
- Топ экранов и категорий

### Обычные вопросы

Все остальные вопросы обрабатываются обычной моделью Ollama:

**Примеры:**
- "Расскажи о проекте EasyPomodoro"
- "Что такое Pomodoro техника?"
- "Помоги с Android разработкой"

## Тестирование

### Тест MCP сервера

Для проверки работы MCP сервера отдельно:

```bash
cd client
python test_analytics.py
```

Этот скрипт:
1. Запускает Analytics MCP сервер
2. Тестирует все 6 инструментов
3. Выводит результаты в консоль
4. Корректно останавливает сервер

### Проверка данных

Просмотр events.json:

```bash
cat client/analytics/events.json | python -m json.tool | head -50
```

## Структура данных

### События (events.json)

**Статистика:**
- 100 событий
- 10 пользователей (user_001 - user_010)
- 10 сессий
- 6 типов экранов
- 7 типов событий

**Распределение пользователей:**
- 20% - успешные покупки (user_001, user_007)
- 30% - брошенные корзины (user_002, user_005)
- 10% - ошибки оплаты (user_003)
- 40% - ранний отток (user_004, user_008, user_009, user_010, user_006)

## Доступные MCP инструменты

| Инструмент | Описание | Параметры |
|------------|----------|-----------|
| `get_events` | Получить события с фильтрами | user_id, event_type, screen, limit |
| `analyze_errors` | Анализ ошибок | top_n |
| `analyze_funnel` | Воронка конверсии | - |
| `analyze_dropoff` | Анализ оттока | - |
| `get_user_journey` | Путь пользователя | user_id |
| `get_statistics` | Общая статистика | - |

## Расширение функциональности

### Добавление новых событий

Отредактируйте `client/analytics/events.json`:

```json
{
  "event_id": "evt_new",
  "user_id": "user_011",
  "session_id": "session_011",
  "timestamp": "2026-01-25T14:00:00Z",
  "event_type": "screen_view",
  "screen": "catalog",
  "properties": {
    "category": "new_category"
  }
}
```

### Добавление новых ключевых слов

Отредактируйте `client/config.py`:

```python
ANALYTICS_KEYWORDS = [
    "ошибк", "error", "аналитик", "analytics",
    "новое_слово"  # добавьте здесь
]
```

### Добавление нового MCP инструмента

1. Добавьте определение в `client/mcp_analytics/server.py` → `list_tools()`
2. Реализуйте обработчик `handle_new_tool()`
3. Добавьте вызов в `call_tool()`
4. Добавьте метод в `client/analytics_manager.py`
5. Добавьте логику в `client/bot.py` → `_handle_analytics_query()`

## Логи и отладка

### Просмотр логов

При запуске бота логи выводятся в консоль:

```
INFO - Starting Ollama manager...
INFO - Starting Analytics MCP server...
INFO - Analytics MCP server started with 6 tools
INFO - Starting Telegram bot
```

### Уровень логирования

Изменить в `client/main.py`:

```python
setup_logging(level=logging.DEBUG)  # для детальных логов
```

## Возможные проблемы

### MCP сервер не запускается

**Проблема:** `Failed to start Analytics MCP server`

**Решение:**
1. Проверьте, что установлен пакет `mcp`: `pip install mcp`
2. Проверьте путь к `events.json`
3. Проверьте логи для деталей ошибки

### Ollama не отвечает

**Проблема:** `Cannot connect to Ollama service`

**Решение:**
1. Убедитесь, что Ollama установлена: `which ollama`
2. Проверьте модель: `ollama list | grep llama3.1:8b`
3. Запустите вручную: `ollama serve`

### Бот не определяет аналитические запросы

**Проблема:** Аналитические вопросы обрабатываются как обычные

**Решение:**
1. Проверьте ключевые слова в `config.py`
2. Используйте явные ключевые слова: "ошибки", "воронка", "статистика"
3. Проверьте логи: должно быть сообщение "Analytics query detected"

## Примеры использования

### Сценарий 1: Анализ проблем с оплатой

**Вопрос:** "Какие ошибки получают пользователи?"

**Ответ бота:**
```
Анализ ошибок показывает следующие проблемы:

**Всего ошибок:** 4
**Уникальных типов:** 4

**Топ ошибок:**

1. PAYMENT_DECLINED (1 случай)
   - Экран: payment
   - Сообщение: "Card declined by bank"

2. PAYMENT_TIMEOUT (1 случай)
   - Экран: payment
   - Сообщение: "Payment gateway timeout"

**Рекомендации:**
- Проблемы концентрируются на экране оплаты
- Необходимо улучшить обработку отклоненных карт
- Рассмотреть увеличение таймаута платежного шлюза
```

### Сценарий 2: Оптимизация воронки

**Вопрос:** "Где больше всего теряется пользователей?"

**Ответ бота:**
```
Анализ оттока пользователей:

**Топ экранов по оттоку:**

1. **confirmation** - 22.22% (2 пользователя)
2. **product** - 22.22% (2 пользователя)
3. **catalog** - 22.22% (2 пользователя)

**Критические точки:**
- Между payment и confirmation теряется 50% пользователей
- Значительный отток на раннем этапе (catalog, product)

**Рекомендации:**
- Упростить процесс оплаты
- Улучшить карточки товаров
- Добавить стимулы для завершения покупки
```

## Дополнительные ресурсы

- Документация по данным: `client/analytics/README.md`
- Тестовый скрипт: `client/test_analytics.py`
- MCP сервер: `client/mcp_analytics/server.py`
- Промпты для аналитики: `client/analytics_prompts.py`

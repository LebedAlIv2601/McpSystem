# Analytics Module

Модуль аналитики данных для анализа поведения пользователей в интернет-магазине.

## Описание

Этот модуль предоставляет:
- **events.json** - моковые данные с ~100 событиями от ~20 пользователей
- **MCP Analytics Server** - локальный MCP сервер с инструментами для анализа
- **Интеграция с Telegram Bot** - автоматическое определение и обработка аналитических запросов

## Структура приложения

Приложение моделирует простой интернет-магазин со следующими экранами:

1. **catalog** - каталог товаров
2. **product** - карточка товара
3. **cart** - корзина
4. **checkout** - оформление заказа (адрес, доставка)
5. **payment** - оплата
6. **confirmation** - подтверждение заказа

## Типы событий

- `session_start` / `session_end` - начало/конец сессии пользователя
- `screen_view` - просмотр экрана
- `button_click` - клик по кнопке
- `add_to_cart` / `remove_from_cart` - операции с корзиной
- `form_submit` - отправка формы
- `error` - ошибка в приложении

## Структура события

```json
{
  "event_id": "evt_001",
  "user_id": "user_001",
  "session_id": "session_001",
  "timestamp": "2026-01-25T10:15:00Z",
  "event_type": "screen_view",
  "screen": "catalog",
  "properties": {
    "category": "electronics"
  }
}
```

## Доступные инструменты анализа

### 1. get_events
Получить события с фильтрами.

**Параметры:**
- `user_id` (optional) - ID пользователя
- `event_type` (optional) - тип события
- `screen` (optional) - экран
- `limit` (optional) - максимум событий (default: 50)

**Пример:**
```python
events = await manager.get_events(user_id="user_001", limit=10)
```

### 2. analyze_errors
Анализ ошибок с группировкой по типу.

**Параметры:**
- `top_n` (optional) - количество топовых ошибок (default: 10)

**Возвращает:**
- Топ ошибок по частоте
- Количество затронутых пользователей
- Экраны, где произошли ошибки
- Примеры сообщений об ошибках

**Пример:**
```python
errors = await manager.analyze_errors(top_n=5)
```

### 3. analyze_funnel
Анализ воронки конверсии по экранам.

**Возвращает:**
- Количество пользователей на каждом этапе
- Процент конверсии от начала воронки
- Процент оттока от предыдущего этапа

**Пример:**
```python
funnel = await manager.analyze_funnel()
```

### 4. analyze_dropoff
Анализ точек оттока пользователей.

**Возвращает:**
- Экраны, где пользователи завершают сессии
- Количество и процент оттока на каждом экране

**Пример:**
```python
dropoff = await manager.analyze_dropoff()
```

### 5. get_user_journey
Детальный путь конкретного пользователя.

**Параметры:**
- `user_id` (required) - ID пользователя

**Возвращает:**
- Хронологический список всех событий пользователя
- Количество сессий
- Общее количество событий

**Пример:**
```python
journey = await manager.get_user_journey("user_001")
```

### 6. get_statistics
Общая статистика использования.

**Возвращает:**
- Всего пользователей
- Всего сессий
- Всего событий
- Завершенные покупки
- Процент конверсии
- Топ экранов
- Популярные категории

**Пример:**
```python
stats = await manager.get_statistics()
```

## Использование в Telegram Bot

Бот автоматически определяет аналитические запросы по ключевым словам:
- `ошибк`, `error` → analyze_errors
- `воронк`, `funnel`, `конверс`, `conversion` → analyze_funnel
- `теряю`, `dropoff`, `отток`, `abandon` → analyze_dropoff
- `статистик`, `statistic`, `общ` → get_statistics

**Примеры запросов:**

1. "Какие ошибки чаще всего получают пользователи?"
   - Вызывает `analyze_errors`
   - Показывает топ ошибок с деталями

2. "Где больше всего пользователей теряется?"
   - Вызывает `analyze_dropoff`
   - Показывает экраны с максимальным оттоком

3. "Какая конверсия в покупку?"
   - Вызывает `analyze_funnel`
   - Показывает воронку от catalog до confirmation

4. "Покажи общую статистику"
   - Вызывает `get_statistics`
   - Показывает все ключевые метрики

## Тестирование

Для тестирования MCP сервера отдельно от бота:

```bash
cd client
python test_analytics.py
```

Этот скрипт запустит MCP сервер и протестирует все инструменты.

## Данные

Файл `events.json` содержит реалистичные сценарии:
- **Успешные покупки** (~20% пользователей) - полный путь через все экраны
- **Брошенные корзины** (~30% пользователей) - добавили товар, но не оформили
- **Ошибки оплаты** (~10% пользователей) - дошли до оплаты, но получили ошибку
- **Ранний отток** (~40% пользователей) - покинули на catalog/product

## Расширение

Для добавления новых событий в `events.json`:

1. Следуйте существующей структуре
2. Используйте уникальные `event_id`
3. Группируйте события по `session_id`
4. Соблюдайте хронологический порядок `timestamp`
5. Добавляйте релевантные `properties` для каждого типа события

Для добавления новых инструментов в MCP сервер:

1. Добавьте определение инструмента в `list_tools()` в `mcp_analytics/server.py`
2. Реализуйте обработчик `handle_<tool_name>()`
3. Добавьте вызов в `call_tool()`
4. Добавьте вспомогательный метод в `AnalyticsManager`
